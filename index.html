<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.1.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.1.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '6.1.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta property="og:type" content="website">
<meta property="og:title" content="Lisiur">
<meta property="og:url" content="http://Lisiur.com/index.html">
<meta property="og:site_name" content="Lisiur">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Lisiur">






  <link rel="canonical" href="http://Lisiur.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Lisiur</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Lisiur</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>




<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
          
  
  <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
</li>

      
        
        
          
  
  <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
</li>

      

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://Lisiur.com/2018/04/10/从一个实例看闭包和对象/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lisiur Day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lisiur">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/10/从一个实例看闭包和对象/" itemprop="url">
                  从一个实例看闭包和对象
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-10T11:00:27+08:00">2018-04-10</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>最近遇到这么一个需求：</p>
<blockquote>
<p>进入一个编辑页面，如果没做任何修改可以直接退出，如果做了任何修改，退出时需要给出提示。</p>
</blockquote>
<p>这是一个很常见的问题，解决思路也很简单，无非在进入编辑页面后，将需要监视是否变化的数据当前状态保存下来，然后在退出时将当前这些数据的状态和之前保存的状态做下对比即可。</p>
<p>实现方案大概是这个样子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// model 为需要监视的变量</span></span><br><span class="line"><span class="keyword">const</span> model = &#123;</span><br><span class="line">    a: <span class="number">1</span>,</span><br><span class="line">    b: <span class="number">2</span>,</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> make_fingerprint = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> args.reduce(<span class="function">(<span class="params">prev, cur</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">JSON</span>.stringify(prev) + <span class="built_in">JSON</span>.stringify(cur)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// origin_fingerprint 为初始状态</span></span><br><span class="line"><span class="keyword">const</span> origin_fingerprint = make_fingerprint(model)</span><br><span class="line"></span><br><span class="line"><span class="comment">// check_change 用来判断当前监视的变量是否有变动</span></span><br><span class="line"><span class="keyword">const</span> check_change = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> current_fingerprint = make_fingerprint(model)</span><br><span class="line">    <span class="keyword">return</span> origin_fingerprint !== current_fingerprint</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的方法确实可以解决这个问题，但是有一个小问题：<br>除了我们最终会使用的 <code>check_change</code> 函数外，需要额外定义一个变量 <code>origin_fingerprint</code>，而实际上，这个变量只会在 <code>check_change</code> 中使用。<br>因此我们能否考虑下如何去掉这个恼人的需要暴露在外面的变量呢？</p>
<p>我的第一想法是使用闭包实现：因为这个是闭包应用的最佳体现啊 —— 隐藏变量</p>
<p>实现方案如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> check_change = <span class="function">(<span class="params">(</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> origin_fingerprint = make_fingerprint(model)</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> current_fingerprint = make_fingerprint(...args)</span><br><span class="line">        <span class="keyword">return</span> origin_fingerprint !== current_fingerprint</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)(model)</span><br></pre></td></tr></table></figure>
<p>实际上我们可以封装出一个更一般的方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> has_changed = <span class="function">(<span class="params">...origins</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> origin_fingerprint = make_fingerprint(...origins)</span><br><span class="line">    <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> make_fingerprint(...args) !== origin_fingerprint</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样，<code>check_change</code> 可以这样实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> check_change = <span class="function">(<span class="params">(</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> check_func = has_changed(model)</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">_</span> =&gt;</span> check_func(model)</span><br><span class="line">&#125;)(model)</span><br></pre></td></tr></table></figure>
<p>我们可以把 <code>make_fingerprint</code> 和 <code>has_changed</code> 写入一个公用库里，这样最终实现的<code>check_change</code> 只需要4行代码而已, 而且不会暴露出额外的变量。</p>
<p>由此，我不得不感叹闭包的强大和便利。<br>但是，可以使用对象来实现同样的功能吗？我给自己提出了这个问题。</p>
<p>闭包传递的是过程，对象传递的是变量。我们可以把变量封装到闭包中，当然应该也是可以通过对象来操控变量。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">CheckWrapper</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.data = data</span><br><span class="line">    <span class="keyword">this</span>.origin_fingerprint = make_fingerprint(<span class="keyword">this</span>.data)</span><br><span class="line">&#125;</span><br><span class="line">CheckWrapper.prototype.check_change = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> make_fingerprint(<span class="keyword">this</span>.data) !== <span class="keyword">this</span>.origin_fingerprint</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以这样使用：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> check_wrapper = <span class="keyword">new</span> CheckWrapper(model)</span><br></pre></td></tr></table></figure>
<p>闭包和变量似乎有异曲同工之妙啊，不是吗？</p>
<p>由此不禁想到 Anton van Straaten 创造一个禅理：“对象只不过是可怜人的闭包，而闭包才是可怜人的对象”</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://Lisiur.com/2018/04/07/纯css实现菜单跟随效果/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lisiur Day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lisiur">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/04/07/纯css实现菜单跟随效果/" itemprop="url">
                  纯css实现菜单跟随效果
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-04-07T16:34:02+08:00">2018-04-07</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>先放一个最终实现的效果图。</p>
<iframe width="100%" height="300" src="//jsfiddle.net/lisiur/wLmLLry3/10/embedded/result/" allowpaymentrequest="" allowfullscreen="allowfullscreen" frameborder="0"></iframe>

<p>首先我们先把 dom 结构写出来：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"nav"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Code<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Issues<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Pull requests<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Projects<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Wiki<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Insights<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>Settings<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>下面我们来分析如何实现上述效果。</p>
<p>首先我们把鼠标放到任意一个菜单上，该菜单的底部都会出现一条从右到左的线。这个比较好实现：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ul</span> <span class="selector-tag">li</span><span class="selector-pseudo">::before</span> &#123;</span><br><span class="line">    <span class="attribute">content</span>: <span class="string">''</span>;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">2px</span> solid <span class="number">#000</span>;</span><br><span class="line">    <span class="attribute">transition</span>: left .<span class="number">2s</span>, width .<span class="number">2s</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">ul</span> <span class="selector-tag">li</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个时候的效果是这样的：</p>
<iframe width="100%" height="300" src="//jsfiddle.net/lisiur/wLmLLry3/11/embedded/result/" allowpaymentrequest="" allowfullscreen="allowfullscreen" frameborder="0"></iframe>

<p>我们看到，当我们从左面一个菜单移动到右面一个菜单时，左面菜单下面的线隐藏的方向是对的，而右面菜单下面的线出现的方向却是错的。这个时候就需要一个神奇的 css 选择符来处理这种情况：~</p>
<p>这里简单解释下 ~ 选择符的作用：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">p</span> ~ <span class="selector-tag">ul</span> &#123;</span><br><span class="line">  <span class="comment">/* blablabla */</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代表 p 标签后的所有 ul 标签。</p>
<p>如此我们可以这样处理上面的问题：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ul</span> <span class="selector-tag">li</span><span class="selector-pseudo">:hover</span> ~ <span class="selector-tag">li</span><span class="selector-pseudo">::before</span> &#123;</span><br><span class="line">    <span class="attribute">left</span>: -<span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加上上面的代码后，就可以实现本文开始所示的效果了。</p>
<p>但是，我想你已经发现一个问题了，没错，第一次将鼠标 hover 到菜单上时，底下的线是从右向左出现的，这与我们读书时的方向是不一致的。<br>你可能会问，为什么一开始的时候不让线就是从左向右出现呢？</p>
<p>首先我们来思考之所以能用纯 css 实现这种效果最大的限制条件：那就是 ~ 选择符。<br>~ 选择符是有方向的，那就是只能选择后面的元素。我们现在考虑从第一个菜单滑动到第二个菜单时发生了什么：</p>
<p>首先当我们将鼠标放到第一个菜单上时，不论是先从左面出现还是先从右面出现，都可以实现，但当我们将鼠标从第一个菜单移动到第二个菜单时，第一个菜单的线必须从左向右消失。这则决定了首次放到菜单上时，底部的线只能是从右向左出现，只有这样才能在离开时从左向右消失。</p>
<p>既然所有的菜单都是设定为从右向左出现，当我们将鼠标从第一个菜单移动到第二个时，第一个菜单表现正常：从左向右消失，但第二个菜单则会和第一个菜单一样从右向左出现。这不是我们想要的效果。好在有 ~ 选择符可以让我们 hover 在第一个菜单上时，改变后面的菜单出现方向。</p>
<p>现在应该明白了，因为 ~ 只能选择后面的元素，所以无法实现首次从左向右出现的效果。那如果有一个和 ~ 相反的选择器岂不是就可以了吗？bingo！<br>是的，如果你这么想大概就已经理解我的意思了，不过可惜的是，并没有这么一种选择器（个人没有查到，若有望告知）。</p>
<p>那这个瑕疵就不能解决了吗？</p>
<p>可以的，这个问题我也考虑了很久，最后突然灵光一现，想到了 flex 的一个属性： <code>flex-direction: row-reverse</code>。</p>
<p>如果使用 flex 的属性的话，可以将 dom 元素反转渲染，这个时候 ~ 选择符表示的含义不正好相反吗？</p>
<p>感觉自己机智的一笔，哈哈。</p>
<p>说干就干，需要注意的是，reverse 后，dom 的顺序在书写时也要反转下，然后就是之前的 left 控制动画要相应的改成 right：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>Settings<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>Insights<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>Wiki<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>Projects<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>Pull requests<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>Issues<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>Code<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">ul</span> &#123;</span><br><span class="line">    <span class="attribute">flex-direction</span>: row-reverse;</span><br><span class="line">    <span class="attribute">justify-content</span>: flex-end;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">ul</span> <span class="selector-tag">li</span><span class="selector-pseudo">::before</span> &#123;</span><br><span class="line">    <span class="attribute">content</span>: <span class="string">''</span>;</span><br><span class="line">    <span class="attribute">position</span>: absolute;</span><br><span class="line">    <span class="attribute">right</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="number">100%</span>;</span><br><span class="line">    <span class="attribute">border-bottom</span>: <span class="number">2px</span> solid <span class="number">#000</span>;</span><br><span class="line">    <span class="attribute">transition</span>: right .<span class="number">2s</span>, width .<span class="number">2s</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">ul</span> <span class="selector-tag">li</span><span class="selector-pseudo">:hover</span><span class="selector-pseudo">::before</span> &#123;</span><br><span class="line">    <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">width</span>: <span class="number">100%</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">ul</span> <span class="selector-tag">li</span><span class="selector-pseudo">:hover</span> ~ <span class="selector-tag">li</span><span class="selector-pseudo">::before</span> &#123;</span><br><span class="line">    <span class="attribute">right</span>: -<span class="number">100%</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果如下所示：</p>
<iframe width="100%" height="300" src="//jsfiddle.net/lisiur/wLmLLry3/17/embedded/result/" allowpaymentrequest="" allowfullscreen="allowfullscreen" frameborder="0"></iframe>




          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://Lisiur.com/2018/03/29/抽象的力量/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lisiur Day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lisiur">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/29/抽象的力量/" itemprop="url">
                  抽象的力量
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-03-29T20:51:35+08:00">2018-03-29</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>私以为抽象是人类最伟大的发明（长相除外）</p>
<p>抽象可以让我们站在更高的维度上创造更更高的维度，进而站在更更高的维度上创造更更更高的维度，进而…</p>
<p>好吧，凡是有点程序员修养的人应该很容易看出这似乎是一个递归（是否会栈溢出，就看个人修养了，手动滑稽）。既然如此我们就从一个递归的例子谈起 —— 请写出一个计算从 a 到 b 的各整数之和的递归函数。</p>
<p>这是一个非常简单的问题，不考虑尾递归的优化，也许此时你已经写下了这样的解决方案：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum_integer</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a &gt; b) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a + sum_integer(a+<span class="number">1</span>, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很棒，接下来我们再写一个计算从 a 到 b 的各个整数立方之和的递归函数。</p>
<p>有了上一个模板，我们也很快给出了下面的答案：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cube</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a * a * a</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum_cube</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a &gt; b) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cube(a) + sum_cube(a+<span class="number">1</span>, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不错哦，接下来我们再写一个计算从 a 到 b 的各个整数开方之和的…打住！作为一个挑剔而又懒惰的程序员，我想你此时内心应该是有句 MMP 要说的，但作为一个有担当的程序员我们还是要笑嘻嘻的解决不是。</p>
<p>我们从这几个需求不难看出几点相似之处：<br>第一，都是求和。<br>第二，都是对 a 到 b 施加以相同的模式之后再求和。</p>
<p>对于第一个例子，我们要对 a 到 b 本身直接求和。而第二个例子，我们要对 a 到 b 每个数立方后求和。我们把这两个例子结合下不难写出下面的第一个更加抽象的求和函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">term, a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a &gt; b) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> term(a) + sum(term, a+<span class="number">1</span>, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有了这个更加抽象的 sum 函数后，我们可以轻松地应对之前提出的第三个问题：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum_sqrt</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sum(<span class="built_in">Math</span>.sqrt, a, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>包括前两个函数也可以使用这个 sum 函数回推过去：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">id</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum_integer</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sum( id, a, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cube</span>(<span class="params">a</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a * a * a</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum_cube</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sum( cube, a, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接下来，无论你再出什么问题，我们都可以立刻给出解决方案了，可以先得意下，但不要得意太久，因为下面这个问题也许现在的抽象程度并解决不了：</p>
<p>计算从 a 到 b 间隔一个数的所有数的和。</p>
<p>歘歘歘你就写下了下面这个函数：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum_interval</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a &gt; b) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a + sum_interval(a+<span class="number">2</span>, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>就在你准备交卷时，你是否看到了我脸上贱贱的笑容呢，没错，我接下来很有可能让你写一个 a 到 b 间隔两个数的和哦。</p>
<p>我们拿<code>sum_interval</code> 和 <code>sum_integer</code>比较一下，不难发现他们只有一处不同，那就是下一次递归需要处理的值的步长不同。</p>
<p>这下我们很快就能给出第二套解决方案了：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum_step</span>(<span class="params">next, a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a &gt; b) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a + sum_step(next(a), b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum_interval</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> sum_step(<span class="function"><span class="params">i</span>=&gt;</span>i+<span class="number">2</span>, a, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>是的，基于之前的讨论，我们很快又构造出一个高阶函数<code>sum_step</code>, 恩？之前的讨论？我们是不是可以把这两个抽象出来的高阶函数再来一次更高的抽象呢？说做就做：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum</span>(<span class="params">term, next, a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( a &gt; b) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> term(a) + sum(term, next, next(a), b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>非常不错哦，很有成就感不是，似乎想高歌一曲？且慢，我们的讨论才刚刚开始呢。</p>
<p>思考下如何写一个类似的求积的函数呢？稍作改变即可：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">product</span>(<span class="params">term, next, a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( a &gt; b) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> term(a) * product(term, next, next(a), b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看，这就是抽象的力量，这个时候让你写一个求 a 到 b 的乘积的函数时，简直信手拈来啊：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">product_integer</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> product(<span class="function"><span class="params">i</span>=&gt;</span>i, i=&gt;i+<span class="number">1</span>, a b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>咦，你看这个 <code>sum</code> 和 <code>product</code> 好像啊？不是吗，<code>product</code> 就是直接在 <code>sum</code> 的基础上修改而来的。</p>
<p>这两个能否再来一次抽象呢？事实上，<code>sum</code> 和 <code>product</code> 都是一个叫做 <code>accumulate</code> 的更一般概念的特殊情况。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">accumulate</span>(<span class="params">method, base, term, next, a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a &gt; b) &#123;</span><br><span class="line">        <span class="keyword">return</span> base</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> method(term(a), accumulate(method, base, term, next, next(a), b))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时我们经过多次抽象终于得到这个神奇的函数 <code>accumulate</code>, 下面让我们来体验下它的威力吧：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum_integer</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> accumulate(</span><br><span class="line">        (a, b) =&gt; a + b,  <span class="comment">// method</span></span><br><span class="line">        <span class="number">0</span>,                <span class="comment">// base</span></span><br><span class="line">        a =&gt; a,           <span class="comment">// term</span></span><br><span class="line">        a =&gt; a + <span class="number">1</span>,       <span class="comment">// next</span></span><br><span class="line">        a, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum_cube</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> accumulate(</span><br><span class="line">        (a, b) =&gt; a + b,  <span class="comment">// method</span></span><br><span class="line">        <span class="number">0</span>,                <span class="comment">// base</span></span><br><span class="line">        a =&gt; a * a * a,   <span class="comment">// term</span></span><br><span class="line">        a =&gt; a + <span class="number">1</span>,       <span class="comment">// next</span></span><br><span class="line">        a, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">sum_interval</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> accumulate(</span><br><span class="line">        (a, b) =&gt; a + b,  <span class="comment">// method</span></span><br><span class="line">        <span class="number">0</span>,                <span class="comment">// base</span></span><br><span class="line">        a =&gt; a,           <span class="comment">// term</span></span><br><span class="line">        a =&gt; a + <span class="number">2</span>,       <span class="comment">// next</span></span><br><span class="line">        a, b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">product_integer</span>(<span class="params">a, b</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> accumulate(</span><br><span class="line">        (a, b) =&gt; a * b,  <span class="comment">// method</span></span><br><span class="line">        <span class="number">1</span>,                <span class="comment">// base</span></span><br><span class="line">        a =&gt; a,           <span class="comment">// term</span></span><br><span class="line">        a =&gt; a + <span class="number">1</span>,       <span class="comment">// next</span></span><br><span class="line">        a, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(考虑到递归的效率我将在下次更新时，补上迭代计算的实现。)</p>
<p>——– updated at 2018/03/30 ——–</p>
<p>下面分别给出一个尾递归优化和迭代计算的 <code>accumulate</code> 实现</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 尾递归</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">accumulate</span>(<span class="params">method, term, next, a, b, rst</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (a &gt; b) &#123;</span><br><span class="line">    <span class="keyword">return</span> rst</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> accumulate(method, term, next, next(a), b, method(term(a), rst))</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// 迭代计算</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">accumulate</span>(<span class="params">method, term, next, a, b</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> rst = term(a)</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = next(a); i &lt;= b; i = next(i)) &#123;</span><br><span class="line">    rst = method(rst, term(i))</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> rst</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://Lisiur.com/2017/10/17/vue-SSR-之webpack构建/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lisiur Day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lisiur">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/17/vue-SSR-之webpack构建/" itemprop="url">
                  vue SSR 之webpack构建
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-17T08:13:25+08:00">2017-10-17</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>为了将相同的 Vue 应用程序提供给客户端，我们需要使用 webpack 来打包我们的 Vue 应用程序。事实上，我们可能需要在服务器上使用 webpack 打包 Vue 应用程序，因为：</p>
<ul>
<li>通常 Vue 应用程序是由 webpack 和 vue-loader 构建，并且许多 webpack 特定功能不能直接在 Node.js 中运行（例如通过 file-loader 导入文件，通过 css-loader 导入 CSS）。</li>
<li>尽管 Node.js 最新版本能够完全支持 ES2015 特性，我们还是需要转译客户端代码以适应老版浏览器。这也会涉及到构建步骤。</li>
</ul>
<p>所以基本看法是，对于客户端应用程序和服务器应用程序，我们都要使用 webpack 打包 - 服务器需要「服务器 bundle」然后用于服务器端渲染(SSR)，而「客户端 bundle」会发送给浏览器，用于混合静态标记。</p>
<p><img src="./webpack-bundle.png" alt=""></p>
<h2 id="基本项目结构"><a href="#基本项目结构" class="headerlink" title="基本项目结构"></a>基本项目结构</h2><p>使用 webpack 来构建时，基本项目结构大概是这个样子：<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">src</span><br><span class="line">├───├── app.js # universal entry</span><br><span class="line">│   ├── app.vue</span><br><span class="line">│   ├── components</span><br><span class="line">│   │   ├── home.vue</span><br><span class="line">│   │   └── item.vue</span><br><span class="line">│   ├── entry-client.js # 仅运行于浏览器</span><br><span class="line">│   ├── entry-server.js # 仅运行于服务器</span><br><span class="line">│   ├── router.js</span><br><span class="line">└───└── store.js</span><br></pre></td></tr></table></figure></p>
<h3 id="app-js"><a href="#app-js" class="headerlink" title="app.js"></a>app.js</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Vue <span class="keyword">from</span> <span class="string">'vue'</span></span><br><span class="line"><span class="keyword">import</span> App <span class="keyword">from</span> <span class="string">'./app.vue'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">createApp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> app = enw VUe(&#123;</span><br><span class="line">    render: <span class="function"><span class="params">h</span> =&gt;</span> h(App)</span><br><span class="line">  &#125;)</span><br><span class="line">  <span class="keyword">return</span> &#123; app &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="entry-client-js"><a href="#entry-client-js" class="headerlink" title="entry-client.js"></a>entry-client.js</h3><p>客户端 entry 只需创建应用程序，并且将其挂载到 DOM 中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">'./app'</span></span><br><span class="line"><span class="comment">// 客户端引导逻辑</span></span><br><span class="line"><span class="keyword">const</span> &#123; app &#125; = createApp()</span><br><span class="line"><span class="comment">// 假定 App.vue 模板中根元素具有 `id="app"`</span></span><br><span class="line">app.$mount(<span class="string">'#app'</span>)</span><br></pre></td></tr></table></figure>
<h3 id="entry-server-js"><a href="#entry-server-js" class="headerlink" title="entry-server.js"></a>entry-server.js</h3><p>服务器 entry 使用 default export 导出函数，并在每次渲染中重复调用此函数。此时，除了创建和返回应用程序实例之外，它不会做太多事情。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; createApp &#125; <span class="keyword">from</span> <span class="string">'./app'</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> context =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; app &#125; = createApp()</span><br><span class="line">  <span class="keyword">return</span> app</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://Lisiur.com/2017/10/15/vue-SSR-之小试牛刀/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lisiur Day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lisiur">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/10/15/vue-SSR-之小试牛刀/" itemprop="url">
                  vue SSR 之小试牛刀
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-10-15T20:46:16+08:00">2017-10-15</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>使用 Vue.js 构建客户端应用时确实很爽，但对 SEO 却并不友好，听说 Vue 已经支持 SSR，趁着周末小试牛刀一把。</p>
<h2 id="什么是-SSR"><a href="#什么是-SSR" class="headerlink" title="什么是 SSR"></a>什么是 SSR</h2><p>Vue.js 是构建客户端应用程序的框架。默认情况下，可以在浏览器中输出 Vue 组件，进行生成 DOM 和操作 DOM。然而，也可以将同一个组件渲染为服务器端的 HTML 字符串，将它们直接发送到浏览器，最后将静态标记”混合”为客户端上完全交互的应用程序。</p>
<h2 id="为什么使用-SSR"><a href="#为什么使用-SSR" class="headerlink" title="为什么使用 SSR"></a>为什么使用 SSR</h2><p>与传统 SPA（Single-Page Application - 单页应用程序）相比，服务器端渲染(SSR)的优势主要在于：</p>
<ul>
<li>更好的 SEO，由于搜索引擎爬虫抓取工具可以直接查看完全渲染的页面。</li>
</ul>
<p>请注意，截至目前，Google 和 Bing 可以很好对同步 JavaScript 应用程序进行索引。在这里，同步是关键。如果你的应用程序初始展示 loading 菊花图，然后通过 Ajax 获取内容，抓取工具并不会等待异步完成后再行抓取页面内容。也就是说，如果 SEO 对你的站点至关重要，而你的页面又是异步获取内容，则你可能需要服务器端渲染(SSR)解决此问题。</p>
<ul>
<li>更快的内容到达时间(time-to-content)，特别是对于缓慢的网络情况或运行缓慢的设备。无需等待所有的 JavaScript 都完成下载并执行，才显示服务器渲染的标记，所以你的用户将会更快速地看到完整渲染的页面。通常可以产生更好的用户体验，并且对于那些「内容到达时间(time-to-content)与转化率直接相关」的应用程序而言，服务器端渲染(SSR)至关重要。</li>
</ul>
<p>使用服务器端渲染(SSR)时还需要有一些权衡之处：</p>
<ul>
<li><p>开发条件所限。浏览器特定的代码，只能在某些生命周期钩子函数(lifecycle hook)中使用；一些外部扩展库(external library)可能需要特殊处理，才能在服务器渲染应用程序中运行。</p>
</li>
<li><p>涉及构建设置和部署的更多要求。与可以部署在任何静态文件服务器上的完全静态单页面应用程序(SPA)不同，服务器渲染应用程序，需要处于 Node.js server 运行环境。</p>
</li>
<li><p>更多的服务器端负载。在 Node.js 中渲染完整的应用程序，显然会比仅仅提供静态文件的 server 更加大量占用 CPU 资源(CPU-intensive - CPU 密集)，因此如果你预料在高流量环境(high traffic)下使用，请准备相应的服务器负载，并明智地采用缓存策略。</p>
</li>
</ul>
<h2 id="基本用法"><a href="#基本用法" class="headerlink" title="基本用法"></a>基本用法</h2><h3 id="安装必须的库"><a href="#安装必须的库" class="headerlink" title="安装必须的库"></a>安装必须的库</h3><p><code>yarn add vue vue-server-renderer</code></p>
<blockquote>
<p>官方推荐使用的 Node.js 是6+版本，但因为我接下来会使用 koa 来构建服务端应用，为了能无缝的使用 async/await，我这里推荐使用 7.6.0+的 Node.js 版本。</p>
</blockquote>
<h3 id="渲染一个-Vue-实例"><a href="#渲染一个-Vue-实例" class="headerlink" title="渲染一个 Vue 实例"></a>渲染一个 Vue 实例</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Vue = <span class="built_in">require</span>(<span class="string">'vue'</span>)</span><br><span class="line"><span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123; <span class="attr">template</span>: <span class="string">`&lt;div&gt;Hello World&lt;/div&gt;`</span> &#125;) </span><br><span class="line"><span class="keyword">const</span> renderer = <span class="built_in">require</span>(<span class="string">'vue-server-renderer'</span>).createRenderer() renderer.renderToString(app, (err, html) =&gt; &#123; </span><br><span class="line">  <span class="keyword">if</span> (err) <span class="keyword">throw</span> err </span><br><span class="line">  <span class="built_in">console</span>.log(html)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><code>vue-server-render</code>库中有个<code>createRenderer</code>函数可以生成一个带有<code>renderToString</code>方法的对象。<code>renderToString</code>方法可以把一个 Vue 实例解析成一个 html 字符串。</p>
<h3 id="与服务器集成"><a href="#与服务器集成" class="headerlink" title="与服务器集成"></a>与服务器集成</h3><p><code>yarn add koa</code></p>
<p>由于服务端渲染的<code>renderer.renderRoString</code>方法是一个带有回调函数的方法，为了使用 <code>async/await</code>我先在 <code>utils.js</code>中创建了一个将带有回调的函数转换为返回<code>promise</code>的方法<code>promisify</code><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// utils.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">promisify</span>(<span class="params">fn</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">argsProxy</span>(<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      fn(...args, (err, res) =&gt; &#123;</span><br><span class="line">        err ? reject(err) : resolve(res)</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = promisify</span><br></pre></td></tr></table></figure></p>
<p>然后我们编写服务端 server 脚本。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.js</span></span><br><span class="line"><span class="keyword">const</span> Vue = <span class="built_in">require</span>(<span class="string">'vue'</span>)</span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; promisify &#125; = <span class="built_in">require</span>(<span class="string">'./utils'</span>)</span><br><span class="line"><span class="keyword">const</span> renderer = <span class="built_in">require</span>(<span class="string">'vue-server-renderer'</span>).createRenderer()</span><br><span class="line"><span class="keyword">const</span> renderToString = promisify(renderer.renderToString)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line">server.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123; <span class="attr">template</span>: <span class="string">`&lt;div&gt;Hello World&lt;/div&gt;`</span> &#125;) </span><br><span class="line">  <span class="keyword">await</span> renderToString(app)</span><br><span class="line">        .then(<span class="function"><span class="params">html</span> =&gt;</span> &#123;</span><br><span class="line">          ctx.body = html</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">          ctx.status = <span class="number">500</span></span><br><span class="line">          ctx.body = <span class="string">'Internal Server Error'</span></span><br><span class="line">        &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure></p>
<h3 id="使用页面模板"><a href="#使用页面模板" class="headerlink" title="使用页面模板"></a>使用页面模板</h3><p><code>createRenderer</code>可以传递一个参数——页面模板，也就是说，我们可以先定义一些模板文件，以在服务端渲染时进行复用。</p>
<p>这个模板文件必须包含一个<code>&lt;!--vue-ssr-outlet--&gt;</code>占位符，用来被 renderer 生成的 HTML 标记所替换。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- template/index.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span><span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;&#123;title&#125;&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--vue-ssr-outlet--&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>于是我们的 server.js 就会变成这样：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// server.js</span></span><br><span class="line"><span class="keyword">const</span> Vue = <span class="built_in">require</span>(<span class="string">'vue'</span>)</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>)</span><br><span class="line"><span class="keyword">const</span> Koa = <span class="built_in">require</span>(<span class="string">'koa'</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; promisify &#125; = <span class="built_in">require</span>(<span class="string">'./utils'</span>)</span><br><span class="line"><span class="keyword">const</span> renderer = <span class="built_in">require</span>(<span class="string">'vue-server-renderer'</span>).createRenderer(&#123;</span><br><span class="line">  template: fs.readFileSync(<span class="string">'./template/index.html'</span>, <span class="string">'utf-8'</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">const</span> renderToString = promisify(renderer.renderToString)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = <span class="keyword">new</span> Koa()</span><br><span class="line"></span><br><span class="line">server.use(<span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> app = <span class="keyword">new</span> Vue(&#123; <span class="attr">template</span>: <span class="string">`&lt;div&gt;Hello World&lt;/div&gt;`</span> &#125;) </span><br><span class="line">  <span class="keyword">const</span> context = &#123;</span><br><span class="line">    title: <span class="string">'Index'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">await</span> renderToString(app, context)</span><br><span class="line">        .then(<span class="function"><span class="params">html</span> =&gt;</span> &#123;</span><br><span class="line">          ctx.body = html</span><br><span class="line">        &#125;)</span><br><span class="line">        .catch(<span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">          ctx.status = <span class="number">500</span></span><br><span class="line">          ctx.body = <span class="string">'Internal Server Error'</span></span><br><span class="line">        &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>)</span><br></pre></td></tr></table></figure>
<p>注意到，模板中有 {{}} 的标记，以及 <code>renderToString</code> 的第二个参数 <code>context</code>, 我们可以通过这种方式，实现简单的模板插值。</p>
<p>至此一个最简单的 SSR Hello World 就实现了。但为了完成 SSR 所需要填的坑远不止这些，还有路由和代码分割，数据预取和状态统一，CSS 管理和流式渲染等诸多问题，我们下次再继续聊。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://Lisiur.com/2017/09/30/跟着-Haskell-学函数式编程（三）：函数/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lisiur Day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lisiur">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/30/跟着-Haskell-学函数式编程（三）：函数/" itemprop="url">
                  跟着-Haskell-学函数式编程（三）：函数
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-30T15:57:55+08:00">2017-09-30</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>作为一门纯函数式编程语言，函数在 haskell 中的重要性不言而喻</p>
<h2 id="调用函数"><a href="#调用函数" class="headerlink" title="调用函数"></a>调用函数</h2><p>Haskell 中调用函数的一般格式如下：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">func</span> arg1 arg2 ...</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>参数不需要括号包裹，参数间也不需要逗号隔开（使用空格）</p>
</blockquote>
<p>因为函数应用的优先级比操作符高，因此下面两个表达式是相等的：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">compare</span> <span class="number">2</span> <span class="number">3</span> == <span class="type">LT</span> <span class="comment">-- True</span></span><br><span class="line">(compare <span class="number">2</span> <span class="number">3</span>) == <span class="type">LT</span> <span class="comment">-- True</span></span><br></pre></td></tr></table></figure></p>
<p>有时候考虑可读性会添加一些额外的括号，而有时候，则必须使用括号来确保编译器理解一个复杂的表达式：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">compare</span> (sqrt <span class="number">3</span>) (sqrt <span class="number">6</span>) <span class="comment">-- LT</span></span><br></pre></td></tr></table></figure></p>
<h2 id="函数类型"><a href="#函数类型" class="headerlink" title="函数类型"></a>函数类型</h2><p>函数是有类型的。简单的说，函数的作用就是将某个（些）类型的数据映射为另一个（些）类型的数据，而函数的类型就是描述函数的这种行为。<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; :t words</span><br><span class="line"><span class="title">words</span> :: <span class="type">String</span> -&gt; [<span class="type">String</span>]</span><br></pre></td></tr></table></figure></p>
<p>根据上面的例子，我们知道 words 函数的类型为 <code>String -&gt; [String]</code>(<code>-&gt;</code>可以读作“映射到”)。<br>而，<code>words :: String -&gt; [String]</code>被称为函数 words 的类型签名。<br>知道函数的类型或类型签名有什么用呢？<br>一方面，在我们不知道这个函数的具体作用时，我们可以通过函数的类型推导出函数的作用。以 words 为例，它的作用是把一个 Sting 型数据映射为一个包含 String 型的数组，再联想到 words 这个词的含义，我们大体可以猜出这是一个字符串分割函数。<br>另一方面，编译器可以在编译的时候，通过类型签名自行推导函数在组合时的正确性，以减少错误。值得注意的是，我们在定义函数时可以手动书写函数的类型签名，也可以省略不写，编译器会自行推导函数的类型签名。</p>
<h2 id="纯度"><a href="#纯度" class="headerlink" title="纯度"></a>纯度</h2><p>副作用本质上是函数的一种不可见的（invisible）输入或输出。Haskell 的函数在默认情况下都是无副作用的：函数的结果只取决于显式传入的参数。<br>我们将带副作用的函数称为“不纯（impure）函数”，而将不带副作用的函数称为“纯（pure）函数”。<br>从类型签名可以看出一个 Haskell 函数是否带有副作用 —— 不纯函数的类型签名都以 IO 开头：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; :<span class="class"><span class="keyword">type</span> readFile</span></span><br><span class="line"><span class="title">readFile</span> :: <span class="type">FilePath</span> -&gt; <span class="type">IO</span> <span class="type">String</span></span><br></pre></td></tr></table></figure></p>
<h2 id="函数定义"><a href="#函数定义" class="headerlink" title="函数定义"></a>函数定义</h2><p>我们先来定义一个最简单的函数：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">add</span> a b = a + b</span><br></pre></td></tr></table></figure></p>
<p><code>=</code> 左边的 add 和 a b 是函数名和函数参数，而右面的 a + b 则是函数体，也称为表达式<br>这个时候我们可以看看定义的这个函数的类型签名长啥样：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Prelude</span>&gt; :t add</span><br><span class="line"><span class="title">add</span> :: <span class="type">Num</span> a =&gt; a -&gt; a -&gt; a</span><br></pre></td></tr></table></figure></p>
<p>可以看到，编译器自动给 add 推导出了它的函数签名，从函数签名中我们可以看到，函数 add 把属于 Num 类型类的两个相同类型数据映射为该类型的一个数据。<br>如果我只想让 add 计算 Int 型的数据该怎么办呢？这时我们可以在定义函数时，手动给它加上类型签名：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">add'</span> :: <span class="type">Int</span> -&gt; <span class="type">Int</span> -&gt; <span class="type">Int</span></span><br><span class="line"><span class="title">add'</span> a b = a + b</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>我们一般给实现相同或类似功能的函数后面加上<code>&#39;</code>以标识</p>
</blockquote>
<h3 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h3><p>在 Haskell 里，可以使用变量来赋予表达式名字：一旦变量绑定了（也即是，关联起）某个表达式，那么这个变量的值就不会改变 —— 我们总能用这个变量来指代它所关联的表达式，并且每次都会得到同样的结果。<br>如果你曾经用过命令式语言，就会发现 Haskell 的变量和命令式语言的变量很不同：在命令式语言里，一个变量通常用于标识一个内存位置（或者其他类似的东西），并且在任何时候，都可以随意修改这个变量的值。因此在不同时间点上，访问这个变量得出的值可能是完全不同的。<br>对变量的这两种不同的处理方式产生了巨大的差别： 在 Haskell 程序里面， 当变量和表达式绑定之后， 我们总能将变量替换成相应的表达式。 但是在声明式语言里面就没有办法做这样的替换，因为变量的值可能无时不刻都处在改变当中。</p>
<blockquote>
<p>我们大概可以把 Haskell 里的变量理解为其他编程语言的 const 声明</p>
</blockquote>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://Lisiur.com/2017/09/24/跟着-Haskell-学函数式编程（二）：List-和-Tuple/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lisiur Day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lisiur">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/24/跟着-Haskell-学函数式编程（二）：List-和-Tuple/" itemprop="url">
                  跟着 Haskell 学函数式编程（二）：List 和 Tuple 
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-24T20:40:44+08:00">2017-09-24</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>列表（或数组）或许是我们使用最频繁的一个数据结构了吧，最常用的 栈 或 队列等数据结构都是以列表为基础实现的。因此几乎每种语言都会对列表这一概念进行原生实现。如 C 系列的统一叫做 Array，而 Python 或 Haskell 则称之为 List。</p>
<h2 id="List"><a href="#List" class="headerlink" title="List"></a>List</h2><p>Haskell 中的 list 是一种单类型的数据结构，可以用来存储多个类型相同的元素。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[] <span class="comment">-- 空 list</span></span><br><span class="line">[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>] <span class="comment">-- [Int]</span></span><br><span class="line">['h', 'e', 'l'', 'l', 'o'] <span class="comment">-- [Char]</span></span><br></pre></td></tr></table></figure>
<p>值得注意的是，所有 String 型的字符串都是由 char 构成的数组，其实 String 只是 [Char] 的语法糖而已。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">['h', 'e', 'l'', 'l', 'o'] == <span class="string">"hello"</span> <span class="comment">-- True</span></span><br></pre></td></tr></table></figure>
<h3 id="List-的常见操作。"><a href="#List-的常见操作。" class="headerlink" title="List 的常见操作。"></a>List 的常见操作。</h3><ul>
<li><p><code>++</code> 拼接两个同类型的 List</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] ++ [<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>] <span class="comment">-- [1,2,3,4,5,6]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>:</code> 连接一个元素到一个 List 前</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>:[<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>] <span class="comment">-- [1,2,3,4]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>!!</code> 按照索引取 List 的某个元素</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"Lisiur"</span> !! <span class="number">0</span> <span class="comment">-- 'L'</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>需要注意的是，索引不在 List 范围之内会报错</p>
</blockquote>
<ul>
<li><p>比较 List 大小（装载可比较元素时）</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>] &gt; [<span class="number">3</span>,<span class="number">2</span>,<span class="number">0</span>] <span class="comment">-- True</span></span><br><span class="line">[<span class="number">1</span>,<span class="number">2</span>] &lt; [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- True</span></span><br><span class="line">[<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] == [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- True</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>head</code> 返回 List 的头部</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">head</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- 1</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>当 List 为空时，会报错</p>
</blockquote>
<ul>
<li><code>tail</code> 返回 List 的尾部<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">tail</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- [2,3]</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>当 List 为空时，会报错</p>
</blockquote>
<ul>
<li><code>last</code> 返回 List 的最后一个元素<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">last</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- 3</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>当 List 为空时，会报错</p>
</blockquote>
<ul>
<li><code>init</code> 返回 List 的最后一个元素之前的部分<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">init</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- [1,2]</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>当 List 为空时，会报错</p>
</blockquote>
<ul>
<li><p><code>length</code> 获取 List 长度</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">length</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- 3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>null</code> 判断 List 是否为空</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">null</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- False</span></span><br><span class="line"><span class="title">null</span> [] <span class="comment">-- True</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>reverse</code> 将一个 List 反转</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">reverse</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- [3,2,1]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>take</code> 获取 List 的前几个元素</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">take</span> <span class="number">2</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- [1,2]</span></span><br><span class="line"><span class="title">take</span> <span class="number">0</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- []</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>maximum</code> 获取 List 中最大的那个元素</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">maximum</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- 3</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>minimum</code> 获取 List 中最小的那个元素</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">minimum</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- 1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>sum</code> 获取 List 所有元素的和</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">sum</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- 6</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>product</code> 获取 List 所有元素的积</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">product</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- 6</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>elem</code> 判断一个元素是否包含于一个 List</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">elem</span> <span class="number">1</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- True</span></span><br><span class="line"><span class="number">1</span> `elem` [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- True</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>..</code> 生成一个区间</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">1.</span><span class="number">.10</span>] <span class="comment">-- [1,2,3,4,5,6,7,8,9,10]</span></span><br><span class="line">[<span class="number">1</span>,<span class="number">3.</span><span class="number">.10</span>] <span class="comment">-- [1,3,5,7,9]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>cycle</code> 生成一个无限循环列表</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">cycle</span> [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>] <span class="comment">-- [1,2,3,1,2,3,1,2,3,...]</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>repeat</code> 生成包含无限个给定值的 List</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">repeat</span> <span class="number">1</span> <span class="comment">-- [1,1,1,1,1,...]</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="List-Comprehension"><a href="#List-Comprehension" class="headerlink" title="List Comprehension"></a>List Comprehension</h3><p>通过它，可以从既有的集合中按照规则产生一个新集合。<br>如果我们要生成一个包含前10个偶数的 List 可以直接这样做：<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">take</span> <span class="number">10</span> [<span class="number">2</span>,<span class="number">4.</span>.]</span><br></pre></td></tr></table></figure></p>
<p>但是如果要生成一个包含3和7的公倍数的 List 该怎么办呢？这里我们就可以使用 List Comprehension<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[x | x &lt;- [<span class="number">1</span>,<span class="number">2.</span>.], x `mod` <span class="number">3</span> == <span class="number">0</span>, x `mod` <span class="number">7</span> == <span class="number">0</span>]</span><br></pre></td></tr></table></figure></p>
<p>我们还可以对多个 List 做叉乘处理<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[x*y | x &lt;- [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>], y &lt;- [<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>], x*y &gt; <span class="number">8</span>] <span class="comment">-- [10,12,12,15,18]</span></span><br></pre></td></tr></table></figure></p>
<h2 id="Tuple"><a href="#Tuple" class="headerlink" title="Tuple"></a>Tuple</h2><p>从某种意义上讲，Tuple(元组)很像List–都是将多个值存入一个个体的容器。但它们却有着本质的不同，一组数字的List就是一组数字，它们的类型相 同，且不关心其中包含元素的数量。而Tuple则要求你对需要组合的数据的数目非常的明确，它的类型取决于其中项的数目与其各自的类型。Tuple中的项 由括号括起，并由逗号隔开。</p>
<p>另外的不同之处就是Tuple中的项不必为同一类型，在Tuple里可以存入多类型项的组合。</p>
<p>使用Tuple前应当事先明确一条数据中应该由多少个项。每个不同长度的Tuple都是独立的类型，所以你就不可以写个函数来给它追加元素。而唯一能做的，就是通过函数来给一个List追加序对，三元组或是四元组等内容。</p>
<blockquote>
<p>Tuple 至少需要有两个元素</p>
</blockquote>
<h3 id="Tuple-常见操作"><a href="#Tuple-常见操作" class="headerlink" title="Tuple 常见操作"></a>Tuple 常见操作</h3><ul>
<li><p>fst 返回一个序对的首项</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">fst</span> (<span class="number">1</span>,<span class="number">2</span>) <span class="comment">-- 1</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>snd 返回一个序对的尾项</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">snd</span> (<span class="number">1</span>,<span class="number">2</span>) <span class="comment">-- 2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>zip 生成一组序对(Pair)的List。它取两个List，然后将它们交叉配对，形成一组序对的List。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">zip</span> [<span class="number">1.</span><span class="number">.5</span>], [<span class="string">"one"</span>, <span class="string">"two"</span>, <span class="string">"three"</span>, <span class="string">"four"</span>, <span class="string">"five"</span>]</span><br><span class="line">[(<span class="number">1</span>,<span class="string">"one"</span>),(<span class="number">2</span>,<span class="string">"two"</span>),(<span class="number">3</span>,<span class="string">"three"</span>),(<span class="number">4</span>,<span class="string">"four"</span>),(<span class="number">5</span>,<span class="string">"five"</span>)]</span><br></pre></td></tr></table></figure>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://Lisiur.com/2017/09/17/跟着-Haskell-学函数式编程（一）：入门/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lisiur Day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lisiur">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/17/跟着-Haskell-学函数式编程（一）：入门/" itemprop="url">
                  跟着 Haskell 学函数式编程（一）：入门
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-17T16:20:05+08:00">2017-09-17</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="一些基本概念"><a href="#一些基本概念" class="headerlink" title="一些基本概念"></a>一些基本概念</h2><p>Haskell 是一门纯函数式语言，在它的众多实现中，有两个被广泛应用，Hugs 和 GHC。Hugs 是一个解释器，主要用于教学。GHC(Glasgow Haskell Compiler)更加注重实践。</p>
<p>GHC 主要有三个部分组成。</p>
<ol>
<li><strong>ghc</strong> 是生成本地原生代码的优化编译器。</li>
<li><strong>ghci</strong> 是一个交互解释器和调试器。</li>
<li><strong>runghc</strong> 是一个以脚本形式运行 Haskell 代码的程序</li>
</ol>
<blockquote>
<p>ghci 是 Haskell 的一个交互解释器和调试器。就像 Python 的 python，Node 的 node 或是 Ruby 的 irb。在 ghci 中我们可以方便的学习和调试 Haskell 代码。</p>
</blockquote>
<h2 id="Haskell-的类型"><a href="#Haskell-的类型" class="headerlink" title="Haskell 的类型"></a>Haskell 的类型</h2><p>Haskell 是静态类型的，也就是说在编译时，每个表达式的类型都已明确。与 Java 和 C 不同，haskell 支持类型推导。写下一个数字，你就没必要另外告诉 haskell 说“它是个数字”，它自己就能推导出来。如此，我们在保证安全性的同时不失代码的简洁性。</p>
<p>定义字符变量（C系列 vs Haskell）</p>
<p>C/C++/Java<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> a = <span class="string">'a'</span>;</span><br></pre></td></tr></table></figure></p>
<p>Haskell<br><figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">a</span> = 'a'</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>在 ghci 中可以使用 :t 命令显示任何表达式的类型</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Prelude&gt; a = &apos;a&apos;</span><br><span class="line">Prelude&gt; :t a</span><br><span class="line">a :: Char</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>x :: y</code> 表示 x 的类型为 y</p>
</blockquote>
<p>如下是 Haskell 的几个常见的类型：</p>
<ol>
<li><strong>Int</strong> 表示整数。7可以是Int，但7.2不可以。Int是有界的，也就是说它由上限和下限。对32位的机器而言，上限一般是214748364，下限是-214748364。</li>
<li><strong>Integer</strong> 表示…也是整数，但它是无界的。这就意味着可以用它存放非常非常大的数，我是说非常大。它的效率不如Int高。</li>
<li><strong>Float</strong> 表示单精度的浮点数。</li>
<li><strong>Double</strong> 表示双精度的浮点数。</li>
<li><strong>Bool</strong> 表示布尔值，它只有两种值：True和False。</li>
<li><strong>Char</strong> 表示一个字符。一个字符由单引号括起，一组字符的List即为字符串。</li>
</ol>
<h2 id="Haskell-的类型变量"><a href="#Haskell-的类型变量" class="headerlink" title="Haskell 的类型变量"></a>Haskell 的类型变量</h2><p>类型变量有点类似于其他语言中的泛型，使用类型变量可以让我们轻而易举写出类型无关的函数。使用到类型变量的函数被称作“多态函数”。</p>
<p>fst 函数可以从一个二元Tuple中取得第一个元素，我们看看它的类型：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Prelude&gt; :t fst</span><br><span class="line">fst :: (a, b) -&gt; a</span><br></pre></td></tr></table></figure>
<p>这里的 a,b 即为类型变量，它可以代表任何类型，我们根据这个类型声明可以知道的是，函数输入的这样一个二元组：第一个元素类型是 a，第二个类型元素是 b（类型 b 可以和类型 a 可以相同），而函数输出的是和第一个元素的类型相同的值。</p>
<h2 id="Haskell-的类型类"><a href="#Haskell-的类型类" class="headerlink" title="Haskell 的类型类"></a>Haskell 的类型类</h2><p>类型定义行为的接口，如果一个类型属于某类型类，那它必实现了该类型类所描述的行为。很多从OOP走过来的人们往往会把类型类当成面向对象语言中的类而感到疑惑，厄，它们不是一回事。易于理解起见，你可以把它看做是java中接口（interface）的类似物。</p>
<p>我们先来看个最普通的函数的类型声明：<code>==</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:t (==)</span><br><span class="line">(==) :: Eq a =&gt; a -&gt; a -&gt; Bool</span><br></pre></td></tr></table></figure>
<p>有意思的是，我们看到了一个新的符号：<code>=&gt;</code>。它的左边的部分叫做类型约束。在没有胖箭头的时候，a 可以代表任何类型，但胖箭头对它进行了类型约束：a 只能是实现 Eq 接口的类型。这里的 Eq 就是类型类的一种。</p>
<p>Haskell 常见的类型类如下：</p>
<ol>
<li><strong>Eq</strong> 这一类型类提供了判断相等性的接口，凡是可比较相等性的类型必属于 Eq 类。Eq 包含可判断相等性的类型。提供实现的函数是 == 和 /= 。所以，只要一个函数有 Eq 类的类型限制，那么它就必定在定义中用到了 == 和 /= 。除函数以外的所有类型都属于 Eq，所以它们都可以判断相等性。</li>
<li><strong>Ord</strong> 包含可比较大小的类型。除了函数以外，我们目前所谈到的所有类型都属于Ord类。Ord包中包含了&lt;,&gt;,&lt;=,&gt;=之类用于比较大小的函数。compare函数取两个Ord类中的相同类型的值作参数，返回比较的结果。这个结果是如下三种类型之一：GT,LT,EQ。</li>
<li><strong>Show</strong> 的成员为可用字符串表示的类型。目前为止，除函数以外的所有类型都是Show的成员。操作Show类型类，最常用的函数表示show。它可以取任一Show的成员类型并将其转为字符串。</li>
<li><strong>Read</strong> 是与Show相反的类型类。read函数可以将一个字符串转为Read的某成员类型。</li>
<li><strong>Enum</strong> 的成员都是连续的类型–也就是可枚举。Enum类存在的主要好处就在于我们可以在Range中用到它的成员类型：每个值都有后继子(successer)和前置子(predecesor)，分别可以通过succ函数和pred函数得到。该类型类包含的类型有：(),Bool,Char,Ordering,Int,Integer,Float和Double。</li>
<li><strong>Bounded</strong> 的成员都有一个上限和下限。</li>
<li><strong>Num</strong> 是表示数字的类型类，它的成员类型都具有数字的特征。</li>
<li><strong>Integral</strong> 同样是表示数字的类型类。Num包含所有的数字：实数和整数。而Intgral仅包含整数，其中的成员类型有Int和Integer。</li>
<li><strong>Floating</strong> 仅包含浮点类型：Float和Double。</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://Lisiur.com/2017/09/06/通过自动化脚本和工具提高工作效率/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lisiur Day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lisiur">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/06/通过自动化脚本和工具提高工作效率/" itemprop="url">
                  通过自动化脚本和工具提高工作效率
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-06T13:40:18+08:00">2017-09-06</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>linux 上有个神器叫做 shell, 通过 shell 你可以给计算机下达任何指令。<br>Mac 上有个神器叫做 Alfred, 通过 Alfred 你可以使用一个快捷键完成任何一个工作流。<br>当 shell 遇见 Alfred，所有的工作流都只是抬手一挥间。</p>
</blockquote>
<p>今天我将通过工作中一个实际的例子来展示我是如何通过自动化脚本(bash)和工具(Alfred)来提高我的工作效率。</p>
<h2 id="事件起因"><a href="#事件起因" class="headerlink" title="事件起因"></a>事件起因</h2><p>事情是这样的，我目前在负责公司门户前端的开发和维护，由于我们采用前后端分离的模式进行开发，所以我可以启动本地服务来伺服前端页面，而所有的异步请求则通过 proxy 代理到后端服务器上。原本是后端会单独在他的机器上启个服务，然后我把前端的请求通过内网代理到他的机器上进行调试。但考虑到前端改动较频繁，后端基本没有改动，加之后端抱怨单独开个服务影响其他工作的进行（公司的电脑，你懂得）。所以我们决定把前端的请求直接代理到已经运行在外网的服务器上，当然这需要部署应用的同事帮我单独设置个特殊代理，而他设置代理的过程就是添加一个特殊的代理配置，将我的 ip 代理到单独的一个上下文中。</p>
<p>本来是个很简单的事情，但问题是，我使用自己的笔记本开发，一旦下班后把笔记本带回去，第二天我的 ip 就变了。于是接下来的事情可想而知，我每天早上都要把我的最新 ip 告诉那位帮我加代理的同事，而他每天都要帮我重新设置一下。</p>
<p>大约两三个星期后吧，他跑过来教会了我如何自己配置代理……</p>
<p>需要做的事情不多，总结起来就三件事：</p>
<ol>
<li>使用 ssh 远程登录服务器</li>
<li>修改某个配置文件，将其 ip 更新为最新的</li>
<li>重新加载配置文件</li>
</ol>
<p>但，作为一个懒猿，我才不会每天都一步步来完成以上这么无聊而又没有技术含量的操作呢</p>
<p>于是就有了这篇文章 :)</p>
<h2 id="开始自动化吧！"><a href="#开始自动化吧！" class="headerlink" title="开始自动化吧！"></a>开始自动化吧！</h2><p>首先我们来梳理下，完成这个工作流所需要做的清单：</p>
<ol>
<li>获取本机 ip</li>
<li>登录远程服务器</li>
<li>修改并重新加载配置文件</li>
</ol>
<p>好，接下来我们一步步来</p>
<h3 id="获取本机-ip"><a href="#获取本机-ip" class="headerlink" title="获取本机 ip"></a>获取本机 ip</h3><p>大家都知道可以通过 <code>ifconfig</code>(linux) 或 <code>ipconfig</code>(windows) 命令来获 ip 信息。那些说通过百度 ip 的程序员就先靠边站吧 :) </p>
<p>但是我们获取的一般是这样的结果：</p>
<p><img src="./ifconfig.png" alt=""></p>
<p>额，你能一眼看到你的 ip 地址吗？反正我每次找起来都挺费力的。我们能不能只获取 ip 呢？可以的，做到这个我们所需要的只是一行脚本而已:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig | grep <span class="string">'inet'</span> | grep -v <span class="string">'inet6'</span> | grep -v <span class="string">'127.0.0.1'</span> | cut -d <span class="string">' '</span> -f2 | awk <span class="string">'&#123; print $1 &#125;'</span></span><br></pre></td></tr></table></figure>
<p><img src="./ip.png" alt=""></p>
<p>Good Job!</p>
<h3 id="登录远程主机"><a href="#登录远程主机" class="headerlink" title="登录远程主机"></a>登录远程主机</h3><p>一般我们都会选择 ssh 来登录远程主机(linux)，方便快捷安全，当然要选择他了。</p>
<p>ssh 登录的一般格式是：<code>ssh username@host</code></p>
<p>比如我们要使用 lisiur这个用户的身份登录一个 ip 为 192.168.31.110 的主机。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh lisiur@192.168.31.110</span><br></pre></td></tr></table></figure>
<p>回车后，它会要求你输入用户密码，然后你就再输入密码回车，就可以进入远程主机的 shell 了(当然，前提是密码正确)。</p>
<p>每次都要输密码，好烦哦，能不输密码吗？可以的，我们只需输入两行命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa</span><br><span class="line">ssh-copy-id username@host</span><br></pre></td></tr></table></figure>
<p>第一个命令回车后会让你设置密码，这里我们保留密码为空，一路回车就好，这时会在本地用户主目录下生成<code>.ssh/id_rsa</code> 和 <code>.ssh/id_rsa.pub</code> 这两个文件。<code>id_rsa</code> 就是你的私钥，<code>id_rsa.pub</code> 就是你的公钥了。</p>
<p>第二个命令会将你的公钥上传到目标服务器的 <code>.ssh/authorized_keys</code> 文件中。</p>
<p>这样，下次再次使用 ssh 登录远程主机时会带上你的私钥，远程主机拿着你的私钥匹配之前上传的公钥，匹配成功就可以确认你的身份而省去输入密码的步骤。</p>
<p>每次都要输入远程主机的 ip 地址，我记不住啊！能不输入 ip 就登录远程主机吗？可以的，我们要做的就是编辑一个文件：</p>
<p>我们可以通过编辑主目录下的 <code>.ssh/config</code> 文件（没有就新建一个），来配置登录主机的别名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 加上下面的配置</span><br><span class="line">Host lisiur</span><br><span class="line">    HostName 192.168.31.110</span><br><span class="line">    User lisiur</span><br></pre></td></tr></table></figure>
<p>如此，下次我们再登录这台主机时就只需要敲下这么一个命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh lisiur</span><br></pre></td></tr></table></figure>
<p>Awesome!</p>
<h3 id="修改并重新加载配置文件"><a href="#修改并重新加载配置文件" class="headerlink" title="修改并重新加载配置文件"></a>修改并重新加载配置文件</h3><p>重新加载配置文件比较简单，我们在终端执行指定的命令即可。有意思的是如何修改配置文件。</p>
<p>大家也许会说，修改文件还不简单，使用 vim 直接打开修改再保存不就好了？是的，确实是这样，但这不够极客，也不利于我们最终将这一套流程整理成脚本来处理。</p>
<p>需要注意的是，我们修改的这个文件只是将原先的 ip 改为最新的 ip 即可。这其实是一个替换操作，如何在不打开文件的前提下修改文件内容呢？sed 和 awk 都是可以的，这里我选择了使用 sed。</p>
<p>我们需要修改的文件大概长这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/lisiur</span><br><span class="line">    proxy http://172.20.5.165:8080;</span><br></pre></td></tr></table></figure>
<p> 我们要做的就是把 172.20.5.165:8080 替换成目标 ip，使用 sed 操作的命令大概长这样：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pattern1=<span class="string">"http://.*;"</span></span><br><span class="line">pattern2=<span class="string">"http://<span class="variable">$1</span>;"</span></span><br><span class="line">sed -i -e <span class="string">"s#<span class="variable">$pattern1</span>#<span class="variable">$pattern2</span>#g"</span> filename</span><br></pre></td></tr></table></figure>
<p> 最后我们可以把这步的操作写成一个脚本：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">pattern1=<span class="string">"http://.*;"</span></span><br><span class="line">pattern2=<span class="string">"http://<span class="variable">$1</span>;"</span></span><br><span class="line">sed -i -e <span class="string">"s#<span class="variable">$pattern1</span>#<span class="variable">$pattern2</span>#g"</span> config_file_path</span><br><span class="line"></span><br><span class="line">result=`nginx -t | grep success`</span><br><span class="line"><span class="keyword">if</span> [[ result != <span class="string">''</span> ]]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  `nginx -s reload` &amp;&amp; <span class="built_in">echo</span> success</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"fail"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>
<p> 我们将上面的脚本保存为 ‘update_proxy.sh’，于是我们可以使用如下命令将配置文件的 ip 更新为 192.168.31.120 并重新加载该配置</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./update_proxy.sh 192.168.31.120:8080</span><br></pre></td></tr></table></figure>
<p> Perfect!</p>
<h3 id="All-Together"><a href="#All-Together" class="headerlink" title="All Together"></a>All Together</h3><p> 如此一来，我的工作就简单了，只要一个命令获取本机 ip，然后 ssh 登录远程主机，并执行 update_proxy.sh 脚本即可完成操作。</p>
<p> 可是这样还是很繁琐，能不能只输入一个命令就完成所有操作呢？当然可以。为了不在远程主机上留下痕迹，我选择把 update_proxy.sh 拿到本地，然后通过 ssh 使远程主机执行本地脚本(这步是可选的)。</p>
<p>把他们结合起来就是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip=`ifconfig | grep <span class="string">'inet'</span> | grep -v <span class="string">'inet6'</span> | grep -v <span class="string">'127.0.0.1'</span> | cut -d <span class="string">' '</span> -f2 | awk <span class="string">'&#123; print $1 &#125;'</span>`</span><br><span class="line">ssh lisiur <span class="string">"bash -s"</span> &lt; ./update_proxy.sh <span class="string">"<span class="variable">$ip</span>:8080"</span></span><br></pre></td></tr></table></figure>
<p>如此我们只需要执行这一个脚本就可以完成所有操作了。</p>
<p>可是我不想打开终端，敲任何指令怎么办呢？</p>
<p>在 Mac 上开发的同学就可以使用 Alfred 这款神器了。 简单的说 Alfred 就是一个工作流管理软件，通过它你可以将各种脚本和输入输出组合起来，最终通过一个快捷键来触发。对于他，我的评价就是买了 Mac 不装 Alfred，你就浪费了一半左右的钱。</p>
<p>由于我们这个脚本比较简单，使用的只是一个触发方式，因此我们只需要在 Alfred 里新建一个工作流，并定义一个触发关键词(比如 upp)，然后在工作流里执行我们写好的 bash 脚本就好了（哦，对了，如果你不喜欢 bash，Alfred 也支持 python 哦） </p>
<p><img src="./alfred-workflow.png" alt=""></p>
<h3 id="A-Brand-New-Day"><a href="#A-Brand-New-Day" class="headerlink" title="A Brand New Day"></a>A Brand New Day</h3><p>这样，每天早上来到公司，只需要打开电脑，敲下 Alt-Space 打开 Alfred 关键词触发窗口，输入 upp 并回车，看到如下的提示后，就可以愉快的调试前端代码了。</p>
<p><img src="./result.png" alt=""></p>
<h2 id="写在后面"><a href="#写在后面" class="headerlink" title="写在后面"></a>写在后面</h2><p>如果我什么也不想敲，就想让他更新配置可以吗？好吧，真够懒的，不过也是可以的。</p>
<p>linux 系列的小伙伴可以使用 crontab 来给系统加个定时任务，比如每周一到周五的早上九点执行该脚本。详细操作流程感兴趣的可以自己 Google 一下。</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://Lisiur.com/2017/09/02/使用树莓派控制数码管/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Lisiur Day">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Lisiur">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2017/09/02/使用树莓派控制数码管/" itemprop="url">
                  使用树莓派控制数码管
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
                
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2017-09-02T11:39:14+08:00">2017-09-02</time>
            

            
            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="设备"><a href="#设备" class="headerlink" title="设备"></a>设备</h2><ol>
<li>树莓派开发板 * 1</li>
<li>四位一体数码管 * 1 (我用的是 F346AH)</li>
<li>母对母杜邦线 * 12</li>
</ol>
<h2 id="连线说明"><a href="#连线说明" class="headerlink" title="连线说明"></a>连线说明</h2><h3 id="必要的说明"><a href="#必要的说明" class="headerlink" title="必要的说明"></a>必要的说明</h3><p>首先上一张树莓派的引脚图<br><img src="./3.jpg" alt="树莓派引脚图"></p>
<p>然后是数码管引脚图<br>一般四位一体数码管的引脚应该如下所示(未考证, F346AH 和 F346BH 是这样的)<br><img src="./2.png" alt="F346AH 引脚图"></p>
<p>可以看到，一共有12个引脚。但是一共有 (7+1)*4 = 32 个小 led 灯。所以从理论上来说 12 个引脚是不能够控制所有 led 的。但伟大的劳动人们智慧是无穷的，他们想出了使用 12 个引脚控制 32 个 led 灯的方法：如上图所示，四个显示区的 a,b,c,d,e,f,g,dp 共用数码管的 a,b,c,d,e,f,g,dp 八个引脚，剩下的 1,2,3,4 四个引脚来控制显示哪一个区域。大家可能会有疑问，这样不还是不能同时控制所有的 led 灯吗。没错，这种方式只能控制四个区域中的一个，但如果我们循环显示每个区域呢，假如每个区域显示 1 秒之后就全部灭掉，然后显示下一个，这样你就会看到，四个区域都能够获得显示自己的机会，只是在我们看来是亮 1 秒 暗 3 秒。但是当我们把间隔时间调小，比如调到 0.005 秒，此时人眼是无法看出来某个区域在闪，这个时候每个区域看似就都能“同时”显示了。</p>
<h3 id="连线"><a href="#连线" class="headerlink" title="连线"></a>连线</h3><p>引脚a =&gt; 26<br>引脚b =&gt; 19<br>引脚C =&gt; 13<br>引脚D =&gt; 6<br>引脚E =&gt; 5<br>引脚F =&gt; 11<br>引脚G =&gt; 9<br>引脚dp =&gt; 10</p>
<p>DIGIT1 =&gt; 12<br>DIGIT2 =&gt; 16<br>DIGIT3 =&gt; 20<br>DIGIT4 =&gt; 21</p>
<blockquote>
<p>注意,这里我使用的是 BCM 模式, 所以 26 对应的是树莓派物理接口的 37, 19 对应的是树莓派物理接口的 35，以此类推</p>
</blockquote>
<h2 id="控制代码"><a href="#控制代码" class="headerlink" title="控制代码"></a>控制代码</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> RPi.GPIO <span class="keyword">as</span> GPIO</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">GPIO.setmode(GPIO.BCM)</span><br><span class="line">GPIO.setwarnings(<span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line">LED_A = <span class="number">26</span></span><br><span class="line">LED_B = <span class="number">19</span></span><br><span class="line">LED_C = <span class="number">13</span></span><br><span class="line">LED_D = <span class="number">6</span></span><br><span class="line">LED_E = <span class="number">5</span></span><br><span class="line">LED_F = <span class="number">11</span></span><br><span class="line">LED_G = <span class="number">9</span></span><br><span class="line">LED_DP = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">DIGIT1 = <span class="number">12</span></span><br><span class="line">DIGIT2 = <span class="number">16</span></span><br><span class="line">DIGIT3 = <span class="number">20</span></span><br><span class="line">DIGIT4 = <span class="number">21</span></span><br><span class="line"></span><br><span class="line">LEDS = [LED_A, LED_B, LED_C, LED_D, LED_E, LED_F, LED_G, LED_DP]</span><br><span class="line">DIGITS = [DIGIT4, DIGIT3, DIGIT2, DIGIT1]</span><br><span class="line"><span class="comment"># TABLE 是只显示数字时，0-9 对应的控制信息</span></span><br><span class="line"><span class="comment"># e.g.</span></span><br><span class="line"><span class="comment">#  dp g f e d c b a</span></span><br><span class="line"><span class="comment"># 0 1 1 0 0 0 0 0 0 =&gt; 0xC0</span></span><br><span class="line"><span class="comment"># 1 1 1 1 1 1 0 0 0 =&gt; 0xF9</span></span><br><span class="line"><span class="comment"># 以此类推</span></span><br><span class="line">TABLE = [<span class="number">0xC0</span>, <span class="number">0xF9</span>, <span class="number">0xA4</span>, <span class="number">0xB0</span>, <span class="number">0x99</span>, <span class="number">0x92</span>, <span class="number">0x82</span>, <span class="number">0xF8</span>, <span class="number">0x80</span>, <span class="number">0x90</span>]</span><br><span class="line"><span class="comment"># Table_WITH_DOT 是同时显示数字和点时，0-9 对应的控制信息</span></span><br><span class="line"><span class="comment"># e.g.</span></span><br><span class="line"><span class="comment">#  dp g f e d c b a</span></span><br><span class="line"><span class="comment"># 0 0 1 0 0 0 0 0 0 =&gt; 0x40</span></span><br><span class="line"><span class="comment"># 1 0 1 1 1 1 0 0 0 =&gt; 0x79</span></span><br><span class="line"><span class="comment"># 以此类推</span></span><br><span class="line">TABLE_WITH_DOT = [<span class="number">0x40</span>, <span class="number">0x79</span>, <span class="number">0x24</span>, <span class="number">0x30</span>, <span class="number">0x19</span>, <span class="number">0x12</span>, <span class="number">0x2</span>, <span class="number">0x78</span>, <span class="number">0x0</span>, <span class="number">0x10</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将所有的区域都灭掉</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">turnOffAll</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="keyword">for</span> digit <span class="keyword">in</span> DIGITS:</span><br><span class="line">        GPIO.output(digit, <span class="keyword">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当显示数字 o 时， 该区域第 n 个 led 是亮还是灭(即判断数字 o 对应控制信息转换成二进制后第 n 位是否为 1)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">isOne</span><span class="params">(o, n)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ((o &gt;&gt; n) % <span class="number">2</span> == <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置显示某个数字时，a,b,c,d,e,f,g,dp 对应引脚给上高或低电压</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">setDigit</span><span class="params">(num, showDP)</span>:</span></span><br><span class="line">    currentTable = TABLE_WITH_DOT <span class="keyword">if</span> showDP <span class="keyword">else</span> TABLE</span><br><span class="line">    <span class="keyword">for</span> index <span class="keyword">in</span> range(len(LEDS)):</span><br><span class="line">        GPIO.output(LEDS[index], <span class="keyword">not</span> isOne(currentTable[num], index))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示第 no 区域，数字 num, showDP 代表显示数字时是否显示点</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">showDigit</span><span class="params">(no, num, showDP)</span>:</span></span><br><span class="line">    turnOffAll()</span><br><span class="line">    setDigit(num, showDP)</span><br><span class="line">    GPIO.output(DIGITS[no], <span class="keyword">False</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化，将所有引脚插入的接口设为输出口</span></span><br><span class="line"><span class="keyword">for</span> IO_NUM <span class="keyword">in</span> (LEDS + DIGITS):</span><br><span class="line">    GPIO.setup(IO_NUM, GPIO.OUT)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    t = <span class="number">0.001</span> <span class="comment"># 每个区域显示的时间间隔</span></span><br><span class="line">    <span class="comment"># 因为这里我们要让前两个显示当前小时数，后两个显示当前分钟数，同时还要从左数第二个区域的点大约每隔0.5秒闪一下。所以这里我们使用 times 变量来记录小点亮灭后所经历的时间间隔次数</span></span><br><span class="line">    times = <span class="number">-1</span></span><br><span class="line">    showDP = <span class="keyword">False</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        curTime = time.localtime(time.time())</span><br><span class="line">        curHour = int(time.strftime(<span class="string">"%H"</span>, curTime))</span><br><span class="line">        curMinute = int(time.strftime(<span class="string">"%M"</span>, curTime))</span><br><span class="line"></span><br><span class="line">        showDigit(<span class="number">3</span>, curHour // <span class="number">10</span>, <span class="keyword">False</span>)</span><br><span class="line">        time.sleep(t)</span><br><span class="line"></span><br><span class="line">        times += <span class="number">4</span></span><br><span class="line">        <span class="keyword">if</span> times &gt; <span class="number">500</span> :</span><br><span class="line">            showDP = <span class="keyword">not</span> showDP</span><br><span class="line">            times = <span class="number">0</span></span><br><span class="line">        showDigit(<span class="number">2</span>, curHour % <span class="number">10</span>, showDP)</span><br><span class="line">        time.sleep(t)</span><br><span class="line"></span><br><span class="line">        showDigit(<span class="number">1</span>, curMinute // <span class="number">10</span>, <span class="keyword">False</span>)</span><br><span class="line">        time.sleep(t)</span><br><span class="line"></span><br><span class="line">        showDigit(<span class="number">0</span>, curMinute % <span class="number">10</span>, <span class="keyword">False</span>)</span><br><span class="line">        time.sleep(t)</span><br><span class="line"></span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 最后清理GPIO口（不做也可以，建议每次程序结束时清理一下，好习惯）</span></span><br><span class="line">GPIO.cleanup()</span><br></pre></td></tr></table></figure>
<h2 id="成品展示"><a href="#成品展示" class="headerlink" title="成品展示"></a>成品展示</h2><iframe height="480" width="400" src="http://player.youku.com/embed/XMzAwMzU5OTUzMg" frameborder="0" allowfullscreen></iframe>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Lisiur Day</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">54</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">9</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">36</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Lisiur Day</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.4.4</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Muse</a> v6.1.0</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.1.0"></script>



  



	





  





  










  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
